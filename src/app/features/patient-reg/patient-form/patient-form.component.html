<div class="card p-4">
  <h2 class="text-3xl font-bold mb-4">Patient Registration Form</h2>
  <form
    [formGroup]="patientForm"
    (ngSubmit)="onSubmit()"
    class="flex flex-column gap-4"
  >
    <!-- Personal Details -->
    <p-panel header="Personal Details" [toggleable]="true">
      <div formGroupName="personalDetails" class="formgrid grid">
        <div class="field col-12 md:col-6">
          <label for="firstName" class="font-medium">First Name</label>
          <input
            pInputText
            id="firstName"
            formControlName="firstName"
            class="w-full"
          />
          @if (
            patientForm.get("personalDetails.firstName")?.invalid &&
            patientForm.get("personalDetails.firstName")?.touched
          ) {
            <small class="p-error block">
              @if (
                patientForm
                  .get("personalDetails.firstName")
                  ?.hasError("required")
              ) {
                First Name is required.
              } @else if (
                patientForm
                  .get("personalDetails.firstName")
                  ?.hasError("invalidName")
              ) {
                Only letters allowed.
              }
            </small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="lastName" class="font-medium">Last Name</label>
          <input
            pInputText
            id="lastName"
            formControlName="lastName"
            class="w-full"
          />
          @if (
            patientForm.get("personalDetails.lastName")?.invalid &&
            patientForm.get("personalDetails.lastName")?.touched
          ) {
            <small class="p-error block">
              @if (
                patientForm
                  .get("personalDetails.lastName")
                  ?.hasError("required")
              ) {
                Last Name is required.
              } @else if (
                patientForm
                  .get("personalDetails.lastName")
                  ?.hasError("invalidName")
              ) {
                Only letters allowed.
              }
            </small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="dateOfBirth" class="font-medium">Date of Birth</label>
          <p-calendar
            id="dateOfBirth"
            formControlName="dateOfBirth"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            styleClass="w-full"
            inputStyleClass="w-full"
          ></p-calendar>
          @if (
            patientForm.get("personalDetails.dateOfBirth")?.invalid &&
            patientForm.get("personalDetails.dateOfBirth")?.touched
          ) {
            <small class="p-error block">
              @if (
                patientForm
                  .get("personalDetails.dateOfBirth")
                  ?.hasError("required")
              ) {
                Date of Birth is required.
              } @else if (
                patientForm
                  .get("personalDetails.dateOfBirth")
                  ?.hasError("futureDate")
              ) {
                Date must be in the past.
              }
            </small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="gender" class="font-medium">Gender</label>
          <p-dropdown
            id="gender"
            [options]="genderOptions"
            formControlName="gender"
            placeholder="Select Gender"
            styleClass="w-full"
          ></p-dropdown>
          @if (
            patientForm.get("personalDetails.gender")?.invalid &&
            patientForm.get("personalDetails.gender")?.touched
          ) {
            <small class="p-error block">Gender is required.</small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="nationality" class="font-medium">Nationality</label>
          <p-dropdown
            id="nationality"
            [options]="nationalityOptions"
            formControlName="nationality"
            placeholder="Select Nationality"
            [filter]="true"
            filterBy="label"
            styleClass="w-full"
          ></p-dropdown>
          @if (
            patientForm.get("personalDetails.nationality")?.invalid &&
            patientForm.get("personalDetails.nationality")?.touched
          ) {
            <small class="p-error block">Nationality is required.</small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="maritalStatus" class="font-medium">Marital Status</label>
          <p-dropdown
            id="maritalStatus"
            [options]="maritalStatusOptions"
            formControlName="maritalStatus"
            placeholder="Select Status"
            styleClass="w-full"
          ></p-dropdown>
          @if (
            patientForm.get("personalDetails.maritalStatus")?.invalid &&
            patientForm.get("personalDetails.maritalStatus")?.touched
          ) {
            <small class="p-error block">Marital Status is required.</small>
          }
        </div>
      </div>
    </p-panel>

    <!-- Contact Info -->
    <p-panel header="Contact Info" [toggleable]="true">
      <div formGroupName="contactInfo" class="formgrid grid">
        <div class="field col-12 md:col-6">
          <label for="email" class="font-medium">Email</label>
          <input pInputText id="email" formControlName="email" class="w-full" />
          @if (
            patientForm.get("contactInfo.email")?.hasError("required") &&
            patientForm.get("contactInfo.email")?.touched
          ) {
            <small class="p-error block">Email is required.</small>
          }
          @if (
            patientForm.get("contactInfo.email")?.hasError("email") &&
            patientForm.get("contactInfo.email")?.touched
          ) {
            <small class="p-error block">Invalid email format.</small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="phoneNumber" class="font-medium">Phone Number</label>
          <input
            pInputText
            id="phoneNumber"
            formControlName="phoneNumber"
            class="w-full"
          />
          @if (
            patientForm.get("contactInfo.phoneNumber")?.invalid &&
            patientForm.get("contactInfo.phoneNumber")?.touched
          ) {
            <small class="p-error block">
              @if (
                patientForm.get("contactInfo.phoneNumber")?.hasError("required")
              ) {
                Phone Number is required.
              } @else if (
                patientForm
                  .get("contactInfo.phoneNumber")
                  ?.hasError("invalidPhone")
              ) {
                Invalid phone number format.
              }
            </small>
          }
        </div>

        <div formGroupName="address" class="col-12 formgrid grid mt-3">
          <h4 class="col-12 text-lg font-medium mb-2">Address</h4>
          <div class="field col-12">
            <label for="street" class="font-medium">Street</label>
            <input
              pInputText
              id="street"
              formControlName="street"
              class="w-full"
            />
            @if (
              patientForm.get("contactInfo.address.street")?.invalid &&
              patientForm.get("contactInfo.address.street")?.touched
            ) {
              <small class="p-error block">Street is required.</small>
            }
          </div>
          <div class="field col-12 md:col-6">
            <label for="city" class="font-medium">City</label>
            <input pInputText id="city" formControlName="city" class="w-full" />
            @if (
              patientForm.get("contactInfo.address.city")?.invalid &&
              patientForm.get("contactInfo.address.city")?.touched
            ) {
              <small class="p-error block">City is required.</small>
            }
          </div>
          <div class="field col-12 md:col-6">
            <label for="state" class="font-medium">State</label>
            <input
              pInputText
              id="state"
              formControlName="state"
              class="w-full"
            />
            @if (
              patientForm.get("contactInfo.address.state")?.invalid &&
              patientForm.get("contactInfo.address.state")?.touched
            ) {
              <small class="p-error block">State is required.</small>
            }
          </div>
          <div class="field col-12 md:col-6">
            <label for="postalCode" class="font-medium">Postal Code</label>
            <input
              pInputText
              id="postalCode"
              formControlName="postalCode"
              class="w-full"
            />
            @if (
              patientForm.get("contactInfo.address.postalCode")?.invalid &&
              patientForm.get("contactInfo.address.postalCode")?.touched
            ) {
              <small class="p-error block">
                @if (
                  patientForm
                    .get("contactInfo.address.postalCode")
                    ?.hasError("required")
                ) {
                  Postal Code is required.
                } @else if (
                  patientForm
                    .get("contactInfo.address.postalCode")
                    ?.hasError("numericOnly")
                ) {
                  Only numbers allowed.
                }
              </small>
            }
          </div>
          <div class="field col-12 md:col-6">
            <label for="country" class="font-medium">Country</label>
            <input
              pInputText
              id="country"
              formControlName="country"
              class="w-full"
            />
            @if (
              patientForm.get("contactInfo.address.country")?.invalid &&
              patientForm.get("contactInfo.address.country")?.touched
            ) {
              <small class="p-error block">Country is required.</small>
            }
          </div>
        </div>
      </div>
    </p-panel>

    <!-- Medical Info -->
    <p-panel header="Medical Info" [toggleable]="true">
      <div formGroupName="medicalInfo" class="flex flex-column gap-4">
        <div class="field">
          <label for="bloodGroup" class="block font-medium mb-2"
            >Blood Group</label
          >
          <p-dropdown
            id="bloodGroup"
            [options]="bloodGroupOptions"
            formControlName="bloodGroup"
            placeholder="Select Blood Group"
            styleClass="w-full md:w-20rem"
          ></p-dropdown>
          @if (
            patientForm.get("medicalInfo.bloodGroup")?.invalid &&
            patientForm.get("medicalInfo.bloodGroup")?.touched
          ) {
            <small class="p-error block">Blood Group is required.</small>
          }
        </div>

        <!-- Allergies -->
        <div>
          <div class="flex justify-content-between align-items-center mb-2">
            <label class="font-medium">Allergies</label>
            <p-button
              label="Add Allergy"
              icon="pi pi-plus"
              (onClick)="addAllergy()"
              size="small"
              [outlined]="true"
            ></p-button>
          </div>
          <div formArrayName="allergies" class="flex flex-column gap-2">
            @for (allergy of allergies.controls; track i; let i = $index) {
              <div class="p-inputgroup">
                <input
                  pInputText
                  [formControlName]="i"
                  placeholder="Allergy Name"
                />
                <button
                  type="button"
                  pButton
                  icon="pi pi-trash"
                  class="p-button-danger"
                  (click)="removeAllergy(i)"
                ></button>
              </div>
              @if (allergies.at(i).invalid && allergies.at(i).touched) {
                <small class="p-error block">Allergy name is required.</small>
              }
            }
          </div>
        </div>

        <!-- Current Medications -->
        <div>
          <div class="flex justify-content-between align-items-center mb-2">
            <label class="font-medium">Current Medications</label>
            <p-button
              label="Add Medication"
              icon="pi pi-plus"
              (onClick)="addMedication()"
              size="small"
              [outlined]="true"
            ></p-button>
          </div>
          <div
            formArrayName="currentMedications"
            class="flex flex-column gap-2"
          >
            @for (med of currentMedications.controls; track i; let i = $index) {
              <div class="p-inputgroup">
                <input
                  pInputText
                  [formControlName]="i"
                  placeholder="Medication Name"
                />
                <button
                  type="button"
                  pButton
                  icon="pi pi-trash"
                  class="p-button-danger"
                  (click)="removeMedication(i)"
                ></button>
              </div>
              @if (
                currentMedications.at(i).invalid &&
                currentMedications.at(i).touched
              ) {
                <small class="p-error block"
                  >Medication name is required.</small
                >
              }
            }
          </div>
        </div>

        <!-- Past Surgeries -->
        <div>
          <div class="flex justify-content-between align-items-center mb-2">
            <label class="font-medium">Past Surgeries</label>
            <p-button
              label="Add Surgery"
              icon="pi pi-plus"
              (onClick)="addSurgery()"
              size="small"
              [outlined]="true"
            ></p-button>
          </div>
          <div formArrayName="pastSurgeries" class="flex flex-column gap-2">
            @for (surgery of pastSurgeries.controls; track i; let i = $index) {
              <div class="p-inputgroup">
                <input
                  pInputText
                  [formControlName]="i"
                  placeholder="Surgery Details"
                />
                <button
                  type="button"
                  pButton
                  icon="pi pi-trash"
                  class="p-button-danger"
                  (click)="removeSurgery(i)"
                ></button>
              </div>
              @if (pastSurgeries.at(i).invalid && pastSurgeries.at(i).touched) {
                <small class="p-error block">Surgery detail is required.</small>
              }
            }
          </div>
        </div>
      </div>
    </p-panel>

    <!-- Emergency Contacts -->
    <p-panel header="Emergency Contacts" [toggleable]="true">
      <div class="flex justify-content-end mb-3">
        <p-button
          label="Add Contact"
          icon="pi pi-plus"
          (onClick)="addEmergencyContact()"
          size="small"
        ></p-button>
      </div>
      <div formArrayName="emergencyContacts" class="flex flex-column gap-3">
        @for (contact of emergencyContacts.controls; track i; let i = $index) {
          <div
            [formGroupName]="i"
            class="surface-card p-3 border-round border-1 surface-border relative"
          >
            <button
              type="button"
              pButton
              icon="pi pi-trash"
              class="p-button-rounded p-button-danger p-button-text absolute top-0 right-0 m-2"
              (click)="removeEmergencyContact(i)"
            ></button>
            <div class="formgrid grid">
              <div class="field col-12 md:col-4">
                <label class="font-medium">Name</label>
                <input pInputText formControlName="name" class="w-full" />
                @if (
                  contact.get("name")?.invalid && contact.get("name")?.touched
                ) {
                  <small class="p-error block">
                    @if (contact.get("name")?.hasError("required")) {
                      Name is required.
                    } @else if (contact.get("name")?.hasError("invalidName")) {
                      Only letters allowed.
                    }
                  </small>
                }
              </div>
              <div class="field col-12 md:col-4">
                <label class="font-medium">Relationship</label>
                <input
                  pInputText
                  formControlName="relationship"
                  class="w-full"
                />
                @if (
                  contact.get("relationship")?.invalid &&
                  contact.get("relationship")?.touched
                ) {
                  <small class="p-error block">Relationship is required.</small>
                }
              </div>
              <div class="field col-12 md:col-4">
                <label class="font-medium">Phone</label>
                <input
                  pInputText
                  formControlName="phoneNumber"
                  class="w-full"
                />
                @if (
                  contact.get("phoneNumber")?.invalid &&
                  contact.get("phoneNumber")?.touched
                ) {
                  <small class="p-error block">
                    @if (contact.get("phoneNumber")?.hasError("required")) {
                      Phone is required.
                    } @else if (
                      contact.get("phoneNumber")?.hasError("invalidPhone")
                    ) {
                      Invalid phone number.
                    }
                  </small>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </p-panel>

    <!-- Insurance Info -->
    <p-panel header="Insurance Info" [toggleable]="true">
      <div formGroupName="insuranceInfo" class="formgrid grid">
        <div class="field col-12 md:col-6">
          <label for="providerName" class="font-medium">Provider Name</label>
          <input
            pInputText
            id="providerName"
            formControlName="providerName"
            class="w-full"
          />
          @if (
            patientForm.get("insuranceInfo.providerName")?.invalid &&
            patientForm.get("insuranceInfo.providerName")?.touched
          ) {
            <small class="p-error block">Provider Name is required.</small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="policyNumber" class="font-medium">Policy Number</label>
          <input
            pInputText
            id="policyNumber"
            formControlName="policyNumber"
            class="w-full"
          />
          @if (
            patientForm.get("insuranceInfo.policyNumber")?.invalid &&
            patientForm.get("insuranceInfo.policyNumber")?.touched
          ) {
            <small class="p-error block">Policy Number is required.</small>
          }
        </div>
        <div class="field col-12">
          <label for="coverageDetails" class="font-medium"
            >Coverage Details</label
          >
          <textarea
            pInputTextarea
            id="coverageDetails"
            formControlName="coverageDetails"
            rows="3"
            class="w-full"
          ></textarea>
          @if (
            patientForm.get("insuranceInfo.coverageDetails")?.invalid &&
            patientForm.get("insuranceInfo.coverageDetails")?.touched
          ) {
            <small class="p-error block">Coverage Details is required.</small>
          }
        </div>
        <div class="field col-12 md:col-6">
          <label for="expirationDate" class="font-medium"
            >Expiration Date</label
          >
          <p-calendar
            id="expirationDate"
            formControlName="expirationDate"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            styleClass="w-full"
            inputStyleClass="w-full"
          ></p-calendar>
          @if (
            patientForm.get("insuranceInfo.expirationDate")?.invalid &&
            patientForm.get("insuranceInfo.expirationDate")?.touched
          ) {
            <small class="p-error block">
              @if (
                patientForm
                  .get("insuranceInfo.expirationDate")
                  ?.hasError("required")
              ) {
                Expiration Date is required.
              } @else if (
                patientForm
                  .get("insuranceInfo.expirationDate")
                  ?.hasError("pastDate")
              ) {
                Date must be in the future.
              }
            </small>
          }
        </div>
      </div>
    </p-panel>

    <div class="flex justify-content-end">
      <p-button
        type="submit"
        label="Submit Registration"
        icon="pi pi-check"
        styleClass="p-button-success"
      ></p-button>
    </div>
  </form>
</div>

@if (submittedData) {
  <div id="submittedDataView" class="card p-4 mt-4 slide-in-bottom">
    <h2 class="text-3xl font-bold mb-4 text-primary">
      Submitted Registration Details
    </h2>

    <div class="grid">
      <!-- Personal Details -->
      <div class="col-12 md:col-6">
        <p-panel header="Personal Details" styleClass="h-full">
          <div class="flex flex-column gap-2">
            <p>
              <strong>Name:</strong>
              {{ submittedData.personalDetails.firstName }}
              {{ submittedData.personalDetails.lastName }}
            </p>
            <p>
              <strong>DOB:</strong>
              {{
                submittedData.personalDetails.dateOfBirth | date: "mediumDate"
              }}
            </p>
            <p>
              <strong>Gender:</strong>
              {{ submittedData.personalDetails.gender }}
            </p>
            <p>
              <strong>Nationality:</strong>
              {{ submittedData.personalDetails.nationality }}
            </p>
            <p>
              <strong>Marital Status:</strong>
              {{ submittedData.personalDetails.maritalStatus }}
            </p>
          </div>
        </p-panel>
      </div>

      <!-- Contact Info -->
      <div class="col-12 md:col-6">
        <p-panel header="Contact Info" styleClass="h-full">
          <div class="flex flex-column gap-2">
            <p><strong>Email:</strong> {{ submittedData.contactInfo.email }}</p>
            <p>
              <strong>Phone:</strong>
              {{ submittedData.contactInfo.phoneNumber }}
            </p>
            <div class="mt-2">
              <strong>Address:</strong>
              <p class="m-0">{{ submittedData.contactInfo.address.street }}</p>
              <p class="m-0">
                {{ submittedData.contactInfo.address.city }},
                {{ submittedData.contactInfo.address.state }}
                {{ submittedData.contactInfo.address.postalCode }}
              </p>
              <p class="m-0">{{ submittedData.contactInfo.address.country }}</p>
            </div>
          </div>
        </p-panel>
      </div>

      <!-- Medical Info -->
      <div class="col-12">
        <p-panel header="Medical Info">
          <div class="grid">
            <div class="col-12 md:col-4">
              <p class="text-xl">
                <strong>Blood Group:</strong>
                {{ submittedData.medicalInfo.bloodGroup }}
              </p>
            </div>

            <div class="col-12 md:col-4">
              <strong>Allergies:</strong>
              <div class="flex flex-wrap gap-2 mt-2">
                @for (
                  allergy of submittedData.medicalInfo.allergies;
                  track $index
                ) {
                  <p-chip
                    [label]="allergy"
                    icon="pi pi-exclamation-circle"
                  ></p-chip>
                } @empty {
                  <span class="text-500 font-italic">None</span>
                }
              </div>
            </div>

            <div class="col-12 md:col-4">
              <strong>Current Medications:</strong>
              <div class="flex flex-wrap gap-2 mt-2">
                @for (
                  med of submittedData.medicalInfo.currentMedications;
                  track $index
                ) {
                  <p-chip [label]="med" icon="pi pi-briefcase"></p-chip>
                } @empty {
                  <span class="text-500 font-italic">None</span>
                }
              </div>
            </div>

            <div class="col-12 mt-3">
              <strong>Past Surgeries:</strong>
              <div class="flex flex-wrap gap-2 mt-2">
                @for (
                  surgery of submittedData.medicalInfo.pastSurgeries;
                  track $index
                ) {
                  <p-chip [label]="surgery" icon="pi pi-heart"></p-chip>
                } @empty {
                  <span class="text-500 font-italic">None</span>
                }
              </div>
            </div>
          </div>
        </p-panel>
      </div>

      <!-- Emergency Contacts -->
      <div class="col-12 md:col-6">
        <p-panel header="Emergency Contacts" styleClass="h-full">
          <div class="flex flex-column gap-3">
            @for (contact of submittedData.emergencyContacts; track $index) {
              <div class="surface-ground p-3 border-round">
                <p class="m-0 font-bold">
                  {{ contact.name }} ({{ contact.relationship }})
                </p>
                <p class="m-0 text-sm">
                  <i class="pi pi-phone mr-1"></i>{{ contact.phoneNumber }}
                </p>
              </div>
            } @empty {
              <span class="text-500 font-italic">None</span>
            }
          </div>
        </p-panel>
      </div>

      <!-- Insurance Info -->
      <div class="col-12 md:col-6">
        <p-panel header="Insurance Info" styleClass="h-full">
          <div class="flex flex-column gap-2">
            <p>
              <strong>Provider:</strong>
              {{ submittedData.insuranceInfo.providerName }}
            </p>
            <p>
              <strong>Policy #:</strong>
              {{ submittedData.insuranceInfo.policyNumber }}
            </p>
            <p>
              <strong>Expires:</strong>
              {{
                submittedData.insuranceInfo.expirationDate | date: "mediumDate"
              }}
            </p>
            <div class="mt-2">
              <strong>Coverage Details:</strong>
              <p class="m-0 text-sm white-space-pre-wrap">
                {{ submittedData.insuranceInfo.coverageDetails }}
              </p>
            </div>
          </div>
        </p-panel>
      </div>
    </div>
  </div>
}
